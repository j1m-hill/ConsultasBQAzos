WITH atividade_flags AS (
  SELECT
    proposal_id,
    -- Verifica se houve 'awaiting_pendencies'
    IF(
      EXISTS (
        SELECT 1
        FROM UNNEST(activities) AS activity
        WHERE activity.data.status = 'awaiting_pendencies'
      ), 'Sim', 'Não'
    ) AS teve_ligacao,

    -- Verifica se houve 'awaiting_validation'
    IF(
      EXISTS (
        SELECT 1
        FROM UNNEST(activities) AS activity
        WHERE activity.data.status = 'awaiting_validation'
      ), 'Sim', 'Não'
    ) AS teve_validacao

  FROM `azos-data.st_mongo_backoffice_underwriting.proposal_activity`
)

SELECT

  pp._created AS data_criacao,
  pp._updated AS ultima_atualizacao,
  pp.proposal_id,
  pp.broker_id,
  pp.status,
  pp.assigned_to AS responsavel,
  pp.status_detail.category,
  pp.status_detail.reason AS motivo_recusa,
  pp.status_detail.is_reversible AS e_reversivel,
  pp.status_detail.is_counter_proposal AS e_contraproposta,
  pp.proposal.sale_channel AS macro_channel,

  ps.payment_method,
  ps.monthly_premium AS premio,
  ps.frequency AS periodicidade,
  pp.proposal.insured_data.profession AS profissao,
  pp.proposal.insured_data.salary AS salario,
  pp.proposal.insured_data.is_smoker AS fumante,
  pp.proposal.insured_data.gender AS genero,

  af.teve_ligacao,
  af.teve_validacao

FROM `azos-data.st_mongo_backoffice_underwriting.proposal` AS pp

LEFT JOIN `azos-data.azos_analytics.tban_proposal_summarize` AS ps
  ON pp.proposal_id = ps.proposal_id

LEFT JOIN atividade_flags AS af
  ON pp.proposal_id = af.proposal_id
