SELECT
  pr.status as Status,
  pr.proposal_id as Proposal,
  TIMESTAMP_SUB(pr._created, INTERVAL 3 HOUR) AS data_criacao,
  pr.proposal.insured_data.full_name AS Nome_Segurado,
  (
    SELECT ch.last_transaction.payment_profile.holder_name
    FROM UNNEST(fi.first_invoice.charges) AS ch
    WHERE ch.last_transaction.payment_profile.holder_name IS NOT NULL
    ORDER BY ch.due_at DESC
    LIMIT 1
  ) AS Nome_pagador,
  ps.payment_method AS Metodo_pagamento,
  pr.proposal.sale_channel AS Canal,
  ps.monthly_premium AS Premio_mensal,
  ps.frequency AS Frequencia

FROM `st_mongo_backoffice_underwriting.proposal` AS pr

LEFT JOIN `st_mongo_backoffice_underwriting.insured_watch_list` AS iw
  ON pr.proposal.insured_data.cpf = iw.cpf

LEFT JOIN `st_mongo_backoffice_underwriting.broker_watch_list` AS bw
  ON pr.broker_id = bw.broker_id

LEFT JOIN `azos_analytics.tban_broker_data_analytics` AS bd
  ON pr.broker_id = bd._id

LEFT JOIN `azos_analytics.tban_proposal_summarize` AS ps
  ON pr.proposal_id = ps.proposal_id

LEFT JOIN `st_mongo_backoffice_underwriting.first_invoice` AS fi
  ON pr.proposal_id = fi.proposal_id

WHERE pr.status = 'awaiting_analysis'
  AND pr._created > '2025-08-25'
  AND pr.proposal.sale_channel = 'b2c'
