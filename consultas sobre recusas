SELECT
  EXTRACT(MONTH FROM TIMESTAMP_SUB(uw._created, INTERVAL 3 HOUR)) AS month,
  COUNT(uw.proposal_id),
  FORMAT ('%.2f', SUM(pp.monthly_premium)) AS premio_total,
  FORMAT ('%.2f', SUM(CASE
    WHEN uw.status = 'refused' THEN pp.monthly_premium
    ELSE 0
  END)) AS premio_recusado
FROM
  `azos-data.st_mongo_backoffice_underwriting.proposal` AS uw
LEFT JOIN
  `azos_analytics.tban_proposal_summarize` AS pp
USING
  (proposal_id)
WHERE
  TIMESTAMP_SUB(uw._created, INTERVAL 3 HOUR) BETWEEN '2025-01-01' AND '2025-08-31'
GROUP BY
  month
ORDER BY
  month
