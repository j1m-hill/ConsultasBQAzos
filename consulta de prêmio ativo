--essa consulta retorna a qtd de casos que passam nesse filtro, estando apenas awaiting_analysis

with base AS (
SELECT
  proposal_id
FROM `st_mongo_backoffice_underwriting.proposal_activity` AS pa
WHERE
  -- Condição 1: Verifica se o status mais recente é 'awaiting_analysis'
  (SELECT data.status FROM UNNEST(pa.activities) AS activity ORDER BY activity.created_at DESC LIMIT 1) = 'awaiting_analysis'
  -- Condição 2: Verifica se nenhum status no histórico está na lista de exclusão
  AND NOT EXISTS (
    SELECT 1
    FROM UNNEST(pa.activities) AS activity
    WHERE activity.data.status IN ('refused', 'accepted', 'in_analysis', 'validated', 'awaiting_validation', 'awaiting_pendencies')
  )
  -- Condição 3: Filtra propostas criadas após a data especificada
  AND pa._created > '2025-08-25'
)

SELECT 
  --proposal_id, monthly_premium, 
  sum(monthly_premium)
  FROM base
  LEFT JOIN `azos_analytics.tban_proposal_summarize`
  using (proposal_id)
  LEFT JOIN `azos_harmonized.attribution_engine`
  using (proposal_id)
  where macro_channel = 'B2C'
